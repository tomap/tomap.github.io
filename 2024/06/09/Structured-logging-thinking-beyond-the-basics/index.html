<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Thomas Piart - tpî.eu - Personal site, blog and resume"><meta name="author" content="Thomas Piart"><meta property="og:title" content="Structured Logging in ASP.Net with ELK - thinking beyond the basics"><meta property="og:description" content="Thomas Piart - tpî.eu - Personal site, blog and resume"><meta property="og:site_name" content="Thomas Piart - tpî.eu - Personal site"><meta property="og:type" content="article"><meta property="og:image" content="https://xn--i-7iq.ws/emoji-image/%E2%9C%82%EF%B8%8F.png"><meta property="og:url" content="https://tpî.eu/2024/06/09/Structured-logging-thinking-beyond-the-basics/"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@tomap"><meta name="generator" content="Hexo"><title>Structured Logging in ASP.Net with ELK - thinking beyond the basics - #csharp - #aspnetcore - Thomas Piart - tpî.eu - Personal site</title><link rel="stylesheet" href="/css/style.css"><link rel="alternate" href="/atom.xml" title="Thomas Piart - tpî.eu - Personal site" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="Thomas Piart - tpî.eu - Personal site" type="application/rss+xml"></head><body class="sans-serif"><header class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db w-100 mw8 center border-box pv3"><div class="db v-mid w-100 tc tr-ns"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/resume/">Resume </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/promote/">Promote</a></div></nav><div class="w-100 tc db dt-ns"><div class="dib dtc-ns w-90-ns white"><h1 class="f1-ns tc tc-ns tl-ns">Structured Logging in ASP.Net with ELK - thinking beyond the basics</h1></div><div class="dib dtc-ns w-10-ns f1 f-5-ns f-6-l mb2"><span class="ec">✂️</span></div></div></header><div class="w-100 ph2 ph4-m ph5-l mv5"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 mw7 left lh-copy pr4-ns pr0-m post-content"><h2>Why are we still talking about it?</h2><p>This article is on how to go beyond structured logging, especially in the context of Logging in Json when the Json is ingested by Elastic Search via Filebeat (or equivalent)</p><p>There are constraints in this case that needs to be taken into account if you want to optimize your logging output</p><h2>What you are doing</h2><p>So you are logging for Elastic Search.</p><p>Your logs are going to be scrapped from the console and sent to Elastic and you are going to be able to display them nicely in Kibana.</p><p>Using Microsoft.Extensions.Logging (<code>ILogger&lt;T&gt;</code>) and JsonConsoleFormatter, you should have code logging like that:</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This is set via injection</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;MyClass&gt; _logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*...*/</span></span><br><span class="line"><span class="built_in">int</span> countMessages = <span class="number">5000</span>;</span><br><span class="line">_logger.LogInformation(<span class="string">&quot;Starting Process&quot;</span>);</span><br><span class="line"><span class="comment">// This is a scope declared high up in the process</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> globalLogScope = _logger.BeginScope(<span class="keyword">new</span> List&lt;KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; &#123; <span class="keyword">new</span>(<span class="string">&quot;TransactionId&quot;</span>, <span class="string">&quot;ABCDE&quot;</span>) &#125;);</span><br><span class="line"><span class="comment">// This is a more local scope applied to only part of the process</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> logScope = _logger.BeginScope(<span class="keyword">new</span> List&lt;KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; &#123; <span class="keyword">new</span>(<span class="string">&quot;RecordId&quot;</span>, <span class="number">1234</span>) &#125;);</span><br><span class="line">_logger.LogWarning(<span class="string">&quot;Too many messages: &#123;Count&#125;&quot;</span>, countMessages);</span><br></pre></td></tr></table></figure><p>And this will produce the following result:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;EventId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyApplication.Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;State&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;&#123;OriginalFormat&#125;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;EventId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyApplication.Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: 5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;State&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: 5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Count&quot;</span><span class="punctuation">:</span> <span class="number">5000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;&#123;OriginalFormat&#125;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: &#123;Count&#125;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System.Collections.Generic.List\u00601[System.Collections.Generic.KeyValuePair\u00602[System.String,System.Object]]&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;TransactionId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ABCDE&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System.Collections.Generic.List\u00601[System.Collections.Generic.KeyValuePair\u00602[System.String,System.Object]]&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;RecordId&quot;</span><span class="punctuation">:</span> <span class="number">1234</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>I have indented those two Jsons, but by default (and this is good for parser), each json will be serialized on a single line. The initial size is 718 bytes</p><h2>Can we improve ?</h2><p>Right… There are plenty of issues with this output. Let’s address them :)</p><p>This is <strong>super verbose and redundant</strong> and this is an issue because we are logging to the console.<br>By default, if a message is longer than ~16k, it will be split over multiple lines, and FileBeat will have a hard time parsing it.</p><p>Note that the max size of the console line can be different on your system, and you (or your DevOps) can change it but the longer it is, the longer your message can be, and that might be an issue for Filebeat (or the equivalent on your system) in terms of performances, throughput, …</p><p>So our objective will be to reduce verbosity and redundancy when possible</p><ul><li>There are useless properties<ul><li>Default values could be skipped, like EventId = 0. I rarely use EventId, but when I use it, it’s nice to be able to filter by this value in Kibana</li></ul></li><li>There are redundant properties:<ul><li>Message is duplicated in Message and in State.Message, even when there is no placeholder</li><li>It is nice to have access to State.{OriginalFormat} because I can easily filter on this type of message in Kibana</li></ul></li></ul><h2>How do we do that ?</h2><p>Let’s take the json console log formatter from Microsoft : <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Logging.Console/src/JsonConsoleFormatter.cs">JsonConsoleFormatter</a> (and <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/blob/02ddff3430d976a7cb3a785b1ec7e33e80796e71/src/libraries/Microsoft.Extensions.Logging.Console/src/JsonConsoleFormatter.cs">the specific commit at the time of writing</a>)</p><p>And adapt it to our needs.</p><p>If we copy this class in our project, we’ll also need to create a CompactJsonConsoleFormatterOptions (the equivalent of <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Logging.Console/src/JsonConsoleFormatterOptions.cs">JsonConsoleFormatterOptions</a> )</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CompactJsonConsoleFormatterOptions</span> : <span class="title">ConsoleFormatterOptions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CompactJsonConsoleFormatterOptions</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JsonWriterOptions JsonWriterOptions &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>And the <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/blob/main/src/libraries/Common/src/System/Text/Json/PooledByteBufferWriter.cs">PooledByteBufferWriter</a> (internal ATTOW)</p><p>I’m going to skip most default values:</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line">writer.WriteNumber(<span class="keyword">nameof</span>(logEntry.EventId), eventId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// after</span></span><br><span class="line"><span class="keyword">if</span> (eventId &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    writer.WriteNumber(<span class="keyword">nameof</span>(logEntry.EventId), eventId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Same for all the items (scope or state):</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line">writer.WriteBoolean(key, boolValue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// after</span></span><br><span class="line"><span class="keyword">if</span> (boolValue)</span><br><span class="line">&#123;</span><br><span class="line">    writer.WriteBoolean(key, boolValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I’m also merging scope and state, and renaming them to something shorter (<code>Sc</code>):</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="keyword">if</span> (logEntry.State != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    writer.WriteStartObject(<span class="keyword">nameof</span>(logEntry.State));</span><br><span class="line">    writer.WriteString(<span class="string">&quot;Message&quot;</span>, logEntry.State.ToString());</span><br><span class="line">    <span class="keyword">if</span> (logEntry.State <span class="keyword">is</span> IReadOnlyCollection&lt;KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; stateProperties)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; item <span class="keyword">in</span> stateProperties)</span><br><span class="line">        &#123;</span><br><span class="line">            WriteItem(writer, item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    writer.WriteEndObject();</span><br><span class="line">&#125;</span><br><span class="line">WriteScopeInformation(writer, scopeProvider);</span><br><span class="line"></span><br><span class="line"><span class="comment">// after</span></span><br><span class="line"> writer.WriteStartObject(<span class="string">&quot;Sc&quot;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (logEntry.State != <span class="literal">null</span>)</span><br><span class="line"> &#123;</span><br><span class="line">     writer.WriteString(<span class="string">&quot;Message&quot;</span>, logEntry.State.ToString());</span><br><span class="line">     <span class="keyword">if</span> (logEntry.State <span class="keyword">is</span> IReadOnlyCollection&lt;KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; stateProperties)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">foreach</span> (KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; item <span class="keyword">in</span> stateProperties)</span><br><span class="line">         &#123;</span><br><span class="line">             WriteItem(writer, item);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> WriteScopeInformation(writer, scopeProvider);</span><br><span class="line"> </span><br><span class="line"> writer.WriteEndObject();</span><br></pre></td></tr></table></figure><p>The <em>small</em> issue with this code is that I’m always creating the “Sc” Object in Json, whether of not there is a scope or state in this log entry.</p><p>Now let’s flatten Scopes:</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WriteScopeInformation</span>(<span class="params">Utf8JsonWriter writer, IExternalScopeProvider? scopeProvider</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (FormatterOptions.IncludeScopes &amp;&amp; scopeProvider != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        writer.WriteStartArray(<span class="string">&quot;Scopes&quot;</span>);</span><br><span class="line">        scopeProvider.ForEachScope((scope, state) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (scope <span class="keyword">is</span> IEnumerable&lt;KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; scopeItems)</span><br><span class="line">            &#123;</span><br><span class="line">                state.WriteStartObject();</span><br><span class="line">                state.WriteString(<span class="string">&quot;Message&quot;</span>, scope.ToString());</span><br><span class="line">                <span class="keyword">foreach</span> (KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; item <span class="keyword">in</span> scopeItems)</span><br><span class="line">                &#123;</span><br><span class="line">                    WriteItem(state, item);</span><br><span class="line">                &#125;</span><br><span class="line">                state.WriteEndObject();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                state.WriteStringValue(ToInvariantString(scope));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, writer);</span><br><span class="line">        writer.WriteEndArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after:</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WriteScopeInformation</span>(<span class="params">Utf8JsonWriter writer, IExternalScopeProvider? scopeProvider</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (FormatterOptions.IncludeScopes &amp;&amp; scopeProvider != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        scopeProvider.ForEachScope((scope, state) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (scope <span class="keyword">is</span> IEnumerable&lt;KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; scopeItems)</span><br><span class="line">            &#123;</span><br><span class="line">                state.WriteString(<span class="string">&quot;Message&quot;</span>, scope.ToString());</span><br><span class="line">                <span class="keyword">foreach</span> (KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; item <span class="keyword">in</span> scopeItems)</span><br><span class="line">                &#123;</span><br><span class="line">                    WriteItem(state, item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                state.WriteStringValue(ToInvariantString(scope));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The new json looks like this:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyApplication.Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Sc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;&#123;OriginalFormat&#125;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyApplication.Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: 5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Sc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: 5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Count&quot;</span><span class="punctuation">:</span> <span class="number">5000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;&#123;OriginalFormat&#125;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: &#123;Count&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System.Collections.Generic.List\u00601[System.Collections.Generic.KeyValuePair\u00602[System.String,System.Object]]&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;TransactionId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ABCDE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System.Collections.Generic.List\u00601[System.Collections.Generic.KeyValuePair\u00602[System.String,System.Object]]&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RecordId&quot;</span><span class="punctuation">:</span> <span class="number">1234</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>As you can see, we have invalid json with a duplicate property: <code>Message</code>.<br>The good news is that the state message is redundant with the field message so we can remove it</p><p>Also, in the case of scope messages, it’s a <code>.ToString()</code> of the scope object.<br>In our case, it’s just a <code>List&lt;T&gt;</code>, so it is useless.<br>In the case of Microsoft Scopes (request scopes), the object used is a bit more interesting, it is an internal object <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.Extensions.Logging/src/LoggerFactoryScopeProvider.cs#L186">ActivityLogScope</a> overloading the <code>ToString()</code> function.<br>However this implementation is just repeating the same exact information that we have as properties later in the message, so we can remove this Message also.</p><p>Here is the new json:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyApplication.Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Sc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;&#123;OriginalFormat&#125;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyApplication.Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: 5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Sc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Count&quot;</span><span class="punctuation">:</span> <span class="number">5000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;&#123;OriginalFormat&#125;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: &#123;Count&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;TransactionId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ABCDE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RecordId&quot;</span><span class="punctuation">:</span> <span class="number">1234</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>We can go further :)</p><p>The Category property represents the namespace of the class emitting the log.<br>What is expected is that most of the logs will come from our own namespace (in my case <code>MyApplication.</code>) so we could replace this with something shorter (a <code>-</code>).<br>Also, when there is no state (no placeholder in our message), the state property <code>&#123;OriginalFormat&#125;</code> contains the same information as our Message, so we can drop it.</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starting Process&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Sc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: 5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Sc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Count&quot;</span><span class="punctuation">:</span> <span class="number">5000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;&#123;OriginalFormat&#125;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: &#123;Count&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;TransactionId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ABCDE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RecordId&quot;</span><span class="punctuation">:</span> <span class="number">1234</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>We are now at 318 bytes, less than half of the initial size</p><p>Also, if we log a large message, it won’t be duplicated in the json if it contains no placeholder.<br>So if you are dumping potentially large payload in your message and you make sure you are not using placeholders, then you can cut the size of your logs in two</p><p>Is if all great, but we have just created an issue which was not present before:</p><p>If two scopes share the same property, they could collide! Same for a scope and a state sharing the same property</p><p>Ex:</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> globalLogScope = _logger.BeginScope(<span class="keyword">new</span> List&lt;KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; &#123; <span class="keyword">new</span>(<span class="string">&quot;Collide&quot;</span>, <span class="string">&quot;ABCDE&quot;</span>), &#125;);</span><br><span class="line"><span class="comment">// This is a more local scope applied to only part of the process</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> logScope = _logger.BeginScope(<span class="keyword">new</span> List&lt;KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; &#123; <span class="keyword">new</span>(<span class="string">&quot;Collide&quot;</span>, <span class="number">1234</span>), &#125;);</span><br><span class="line">_logger.LogWarning(<span class="string">&quot;Too many messages: &#123;Collide&#125;&quot;</span>, countMessages);</span><br></pre></td></tr></table></figure><p>Will produce:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-Controllers.MyController&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: 5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Sc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Collide&quot;</span><span class="punctuation">:</span> <span class="number">5000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;&#123;OriginalFormat&#125;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many messages: &#123;Collide&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Collide&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ABCDE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Collide&quot;</span><span class="punctuation">:</span> <span class="number">1234</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>So let’s fix this by using a small HashSet to detect collisions and resolve them with a suffix number</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> suffixString = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> suffixNumber = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(keys.Contains(item.Key + suffixString) &amp;&amp; suffixNumber &lt; <span class="number">10</span>)&#123;</span><br><span class="line">    suffixNumber++;</span><br><span class="line">    suffixString = suffixNumber.ToString();</span><br><span class="line">&#125;</span><br><span class="line">keys.TryAdd(item.Key + suffixString);</span><br><span class="line">writer.WriteString(item.Key + suffixString, item.Value.ToString());</span><br></pre></td></tr></table></figure><p>This code is not bullet proof, but I have rarely seen more than one collision.</p><p>Et voila, a much optimized Json Console formatter.</p><div class="pt3"><span class="ec pr2">🕗</span>2024-06-09</div><div class="pt3"><span class="ec ec-mono pr2">🔖</span> <a class="mr3" href="/tags/csharp/">#csharp</a> <a class="mr3" href="/tags/aspnetcore/">#aspnetcore</a></div><div class="pt3 comment"><span class="ec ec-mono pr2">💬</span><span class="mr2">Comment on</span> <a class="mr3 ic ic-share ic-github" href="https://github.com/tomap/tpi2.eu/issues/new?labels=comment&amp;title=Structured%20Logging%20in%20ASP.Net%20with%20ELK%20-%20thinking%20beyond%20the%20basics&amp;body=%0A%0AUrl:%20https://tp%C3%AE.eu/2024/06/09/Structured-logging-thinking-beyond-the-basics/" target="_blank" rel="noopener noreferrer">github </a><a class="mr3 ic ic-share ic-linkedin" href="https://www.linkedin.com/sharing/share-offsite/?url=https://tp%C3%AE.eu/2024/06/09/Structured-logging-thinking-beyond-the-basics/" target="_blank" rel="noopener noreferrer">linkedin </a><a class="mr3 ic ic-share ic-twitter" href="https://twitter.com/intent/tweet?url=https://tp%C3%AE.eu/2024/06/09/Structured-logging-thinking-beyond-the-basics/&amp;via=tomap" target="_blank" rel="noopener noreferrer">twitter</a></div></div></div></div></div></div><footer class="bg-1 ph2 ph5-ns pv5 center tc"><a class="dib m3 glow o-70 link black ma2" href="https://hachyderm.io/@tomap" target="_blank" rel="me noopener noreferrer"><i class="ic ic-mastodon"></i> <span class="db mt2">Mastodon</span> </a><a class="dib m3 glow o-70 link black ma2" href="https://stackoverflow.com/users/383029/tomap" target="_blank" rel="noopener noreferrer"><i class="ic ic-stackoverflow"></i> <span class="db mt2">StackOverflow</span> </a><a class="dib m3 glow o-70 link black ma2" href="https://github.com/tomap/" target="_blank" rel="noopener noreferrer"><i class="ic ic-github"></i> <span class="db mt2">GitHub</span> </a><a class="dib m3 glow o-70 link black ma2" href="https://www.linkedin.com/in/thomaspiart/" target="_blank" rel="noopener noreferrer"><i class="ic ic-linkedin"></i> <span class="db mt2">LinkedIn</span> </a><a class="dib m3 glow o-70 link black ma2" href="https://twitter.com/tomap" target="_blank" rel="noopener noreferrer"><i class="ic ic-twitter"></i> <span class="db mt2">Twitter</span> </a><a class="dib m3 glow o-70 link black ma2" href="/rss2.xml" target="_blank" rel="noopener noreferrer"><i class="ic ic-rss"></i> <span class="db mt2">Rss</span></a></footer></body></html>